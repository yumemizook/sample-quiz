<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WKVCH BGHKT MDHQA ECUQK MVFX</title>
    <link rel="stylesheet" href="index.css">
    <style>
        /* Embed ModernDOS font */
        @font-face {
            font-family: 'ModernDOS';
            src: url('font/ModernDOS8x16.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* Simplistic theme - applied from the start */
        body {
            background: #000000 !important;
            color: #00ff00 !important;
            font-family: 'ModernDOS', 'Courier New', Courier, monospace !important;
        }
        
        .simplistic-theme {
            background: #000000 !important;
            color: #00ff00 !important;
        }
        
        .simplistic-theme .container {
            background: transparent !important;
            border: 1px solid #00ff00 !important;
            color: #00ff00 !important;
        }
        
        .simplistic-theme .container button {
            background: #000000 !important;
            color: #00ff00 !important;
            border: 1px solid #00ff00 !important;
            font-family: 'ModernDOS', 'Courier New', Courier, monospace !important;
        }
        
        .simplistic-theme a {
            color: #00ff00 !important;
        }
        
        .simplistic-theme .question {
            color: #00ff00 !important;
            font-family: 'ModernDOS', 'Courier New', Courier, monospace !important;
        }
        
        .simplistic-theme .options label {
            color: #00ff00 !important;
            font-family: 'ModernDOS', 'Courier New', Courier, monospace !important;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            z-index: -1;
        }
        
        .container button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #000000;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: 'ModernDOS', 'Courier New', Courier, monospace;
        }
        
        a {
            text-decoration: none;
            color: #00ff00;
            font-size: x-large;
        }
    </style>
</head>

<body class="simplistic-theme">
    <div class="status">
        <span class="name hide"></span>
        <a login href="signin.html">Login</a>
        <a signup href="signup.html">Signup</a>
        <a logout class="hide" href="index.html">Log out</a>
        <a giveup href="index.html">Give up</a>
    </div>
    <div style="display: flex; align-items: flex-start; gap: 20px; justify-content: center; width: 100%;">
      <div class="container" style="width: 800px; max-width: 800px;">
        <div class="question" id="ques"></div>
        <div class="options" id="opt"></div>
        <button onclick="checkAns()" id="btn">SUBMIT</button>
        <div class="correctanswer"></div>
        <div class="jum" style="display: flex; justify-content: space-between; font-family: 'ModernDOS', 'Courier New', Courier, monospace; color: #00ff00;">
            <div id="score"></div>
            <div id="timeelapsed"></div>
        </div>
        <div class="timerifinvalid"></div>
        <div id="notification" class="notification hide"></div>
      </div>
      <div class="evalscreen" style="display:none"></div>
    </div>
    <script type="module" src="./IR.js"></script>
    <script type="module" src="./firebase.js"></script>
    <script type="module" src="./hm.js"></script>
    <script type="module">
        import { getAuth, getFirestore, collection, getDocs, onAuthStateChanged } from "./firebase.js";

        const auth = getAuth();
        const db = getFirestore();
        
        // Check if user has completed hell mode before allowing access
        let accessCheckDone = false;
        async function checkHellModeCompletion() {
            if (accessCheckDone) {
                return true; // Already checked
            }
            
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe(); // Only check once
                    accessCheckDone = true;
                    
                    if (!user) {
                        alert("You must be logged in to access Secret Mode.");
                        window.location.href = "index.html";
                        resolve(false);
                        return;
                    }
                    
                    try {
                        const uid = user.uid;
                        const hellSnap = await getDocs(collection(db, "playerData", uid, "hell"));
                        
                        if (hellSnap.empty) {
                            alert("You must complete Hell Mode at least once to access Secret Mode.");
                            window.location.href = "index.html";
                            resolve(false);
                            return;
                        }
                        
                        // Check if user has any completed hell mode run (score === 200)
                        const hellScores = hellSnap.docs.map(doc => doc.data());
                        const hasCompleted = hellScores.some(score => score.score === 200);
                        
                        if (!hasCompleted) {
                            alert("You must complete Hell Mode (score 200/200) to access Secret Mode.");
                            window.location.href = "index.html";
                            resolve(false);
                            return;
                        }
                        
                        resolve(true);
                    } catch (error) {
                        console.error("Error checking hell mode completion:", error);
                        alert("Error verifying access. Please try again.");
                        window.location.href = "index.html";
                        resolve(false);
                    }
                });
            });
        }
        
        // Wait for access check before initializing quiz
        let accessGranted = false;
        checkHellModeCompletion().then(hasAccess => {
            accessGranted = hasAccess;
            if (hasAccess) {
                // Start quiz after access is granted - use window to make it accessible
                if (window.startQuiz) {
                    window.startQuiz();
                } else {
                    // Wait a bit for script to load
                    setTimeout(() => {
                        if (window.startQuiz) {
                            window.startQuiz();
                        }
                    }, 100);
                }
            }
        });
    </script>
    <script>
        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Gamepad support
        let gamepadConnected = false;
        let answerOptions = [];
        
        // Initialize gamepad support
        function initGamepad() {
            window.addEventListener("gamepadconnected", (e) => {
                gamepadConnected = true;
                inputType = 'controller';
                startGamepadPolling();
            });
            
            window.addEventListener("gamepaddisconnected", (e) => {
                gamepadConnected = false;
                if (inputType === 'controller') {
                    inputType = 'keyboard';
                }
                stopGamepadPolling();
            });
            
            // Check for already connected gamepads
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    gamepadConnected = true;
                    inputType = 'controller';
                    startGamepadPolling();
                    break;
                }
            }
        }
        
        function startGamepadPolling() {
            if (window.gamepadPollInterval) return;
            window.gamepadPollInterval = setInterval(() => {
                const gamepads = navigator.getGamepads();
                for (let i = 0; i < gamepads.length; i++) {
                    const gamepad = gamepads[i];
                    if (gamepad) {
                        handleGamepadInput(gamepad);
                        break;
                    }
                }
            }, 50);
        }
        
        function stopGamepadPolling() {
            if (window.gamepadPollInterval) {
                clearInterval(window.gamepadPollInterval);
                window.gamepadPollInterval = null;
            }
        }
        
        function handleGamepadInput(gamepad) {
            // D-pad navigation for answer selection
            const dpadUp = gamepad.buttons[12]?.pressed || false;
            const dpadDown = gamepad.buttons[13]?.pressed || false;
            const dpadLeft = gamepad.buttons[14]?.pressed || false;
            const dpadRight = gamepad.buttons[15]?.pressed || false;
            
            // Handle answer selection
            if (dpadUp && answerOptions[0]) {
                answerOptions[0].checked = true;
            } else if (dpadRight && answerOptions[1]) {
                answerOptions[1].checked = true;
            } else if (dpadDown && answerOptions[2]) {
                answerOptions[2].checked = true;
            } else if (dpadLeft && answerOptions[3]) {
                answerOptions[3].checked = true;
            }
            
            // Submit button (A button)
            const aPressed = gamepad.buttons[0]?.pressed || false;
            if (aPressed && !window.gamepadSubmitPressed) {
                window.gamepadSubmitPressed = true;
                checkAns();
            } else if (!aPressed) {
                window.gamepadSubmitPressed = false;
            }
        }
        
        initGamepad();
        
        // Keyboard support
        function initKeyboard() {
            document.addEventListener("keydown", (e) => {
                const evalDiv = document.querySelector(".evalscreen");
                if (evalDiv && evalDiv.style.display !== "none" && evalDiv.style.display !== "") {
                    return;
                }
                if (!allQuestions || allQuestions.length === 0) {
                    return;
                }
                if (e.key >= "1" && e.key <= "4") {
                    const index = parseInt(e.key) - 1;
                    if (answerOptions && answerOptions[index]) {
                        answerOptions[index].checked = true;
                        e.preventDefault();
                    }
                }
                if (e.key === " " || e.key === "Enter") {
                    const submitBtn = document.querySelector('#btn');
                    if (submitBtn && submitBtn.style.display !== "none") {
                        checkAns();
                        e.preventDefault();
                    }
                }
            });
        }
        initKeyboard();
        
        document.querySelector('#btn').addEventListener('click', checkAns);
        const ques = document.getElementById("ques");
        
        let allQuestions = [];
        let currQuestion = 0;
        let score = 0;
        let questionStartTime = null;
        let timeToAnswer = null;
        let initialTimeToAnswer = null;
        let quizAbandoned = false;
        let quizMinutes = 0;
        let timer = null;
        let inputType = null; // 'controller', 'keyboard', or 'mobile'
        
        // BGM for secret mode
        let bgm6 = null;
        let currentBGM = null;
        
        function playBGM() {
            if (!bgm6) {
                bgm6 = new Audio("bgm/stage6.mp3");
                bgm6.loop = true;
            }
            
            if (!currentBGM) {
                currentBGM = bgm6;
                currentBGM.play().catch(err => console.log("BGM play failed:", err));
            }
        }
        
        function stopBGM() {
            if (currentBGM) {
                currentBGM.pause();
                currentBGM.currentTime = 0;
                currentBGM = null;
            }
        }
        
        // Detect input type
        if (isMobile) {
            inputType = 'mobile';
        } else if (gamepadConnected) {
            inputType = 'controller';
        } else {
            inputType = 'keyboard';
        }
        
        // Track keyboard input type
        document.addEventListener("keydown", () => {
            if (!inputType || inputType === 'mobile') {
                inputType = 'keyboard';
            }
        });
        
        async function fetchQuestions() {
            try {
                const totalQuestions = 300;
                const questionsPerRequest = 50;
                const numRequests = Math.ceil(totalQuestions / questionsPerRequest);
                
                allQuestions.length = 0;
                let failedRequests = 0;
                
                for (let i = 0; i < numRequests; i++) {
                    if (i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                    
                    const amount = i === numRequests - 1 
                        ? totalQuestions - (i * questionsPerRequest) 
                        : questionsPerRequest;
                    
                    try {
                        const response = await fetch(`https://opentdb.com/api.php?amount=${amount}&difficulty=hard&type=multiple`);
                        if (!response.ok) {
                            console.warn(`Request ${i + 1} failed with status ${response.status}`);
                            failedRequests++;
                            continue;
                        }
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            allQuestions.push(...data.results);
                        } else {
                            console.warn(`Request ${i + 1} returned no questions`);
                            failedRequests++;
                        }
                    } catch (requestError) {
                        console.error(`Error in request ${i + 1}:`, requestError);
                        failedRequests++;
                    }
                }
                
                if (allQuestions.length === 0) {
                    throw new Error("Failed to fetch any questions. Please try again.");
                }
                
                if (allQuestions.length < totalQuestions) {
                    console.warn(`Warning: Expected ${totalQuestions} questions but got ${allQuestions.length}. Continuing with available questions.`);
                }
            } catch (error) {
                console.error("Error fetching questions:", error);
                document.querySelector('#btn').innerHTML = "Refresh";
                document.querySelector('#btn').onclick = () => {
                    location.reload();
                };
                ques.innerHTML = `<h5 style='color: #00ff00'>${error.message || error}</h5>`;
            }
        }
        
        ques.innerHTML = `<h5>THE PROLOGUE OF THE END. LOADING QUESTIONS...</h5>`;
        document.querySelector('#btn').style.display = "none";
        
        // Handle give up button
        const giveUpBtn = document.querySelector("[giveup]");
        if (giveUpBtn) {
            giveUpBtn.addEventListener("click", (e) => {
                e.preventDefault();
                if (confirm("Are you sure you want to give up? Your current progress will be saved.")) {
                    quizAbandoned = true;
                    evalScreen();
                }
            });
        }
        
        async function startQuiz() {
            await fetchQuestions();
            if (allQuestions.length === 0) {
                ques.innerHTML = `<h5 style='color: #00ff00'>Unable to fetch data, Please try again!!</h5>`;
                document.querySelector('#btn').style.display = "block";
                document.querySelector('#btn').innerHTML = "Refresh";
                document.querySelector('#btn').onclick = () => {
                    location.reload();
                };
            } else {
                loadQues();
                stopWatch();
                playBGM(); // Start BGM when quiz begins
            }
        }
        
        // Make startQuiz accessible globally
        window.startQuiz = startQuiz;
        
        
        function loadQues() {
            if (!allQuestions || allQuestions.length === 0 || currQuestion < 0 || currQuestion >= allQuestions.length) {
                console.warn("Invalid question state");
                return;
            }
            
            const opt = document.getElementById("opt");
            let currentQuestion = allQuestions[currQuestion].question;
            
            function decodeHTMLEntities(text) {
                if (!text) return "";
                const txt = document.createElement('textarea');
                txt.innerHTML = text;
                return txt.value;
            }
            
            currentQuestion = decodeHTMLEntities(currentQuestion);
            ques.innerHTML = currentQuestion;
            ques.style.color = "#00ff00";
            ques.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
            
            opt.innerHTML = "";
            loadScore();
            
            const correctAnswer = allQuestions[currQuestion].correct_answer;
            const incorrectAnswers = allQuestions[currQuestion].incorrect_answers;
            const options = [correctAnswer, ...incorrectAnswers];
            options.sort(() => Math.random() - 0.5);
            
            answerOptions = [];
            const controllerButtonImages = ["btns/up.png", "btns/right.png", "btns/down.png", "btns/left.png"];
            const controllerLabels = ["D-Pad Up", "D-Pad Right", "D-Pad Down", "D-Pad Left"];
            
            options.forEach((option, index) => {
                const decodedOption = decodeHTMLEntities(option);
                const choicesdiv = document.createElement("div");
                const choice = document.createElement("input");
                const choiceLabel = document.createElement("label");
                choice.type = "radio";
                choice.name = "answer";
                choice.value = decodedOption;
                choiceLabel.textContent = decodedOption;
                choiceLabel.style.color = "#00ff00";
                choiceLabel.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
                
                const controllerIndicator = document.createElement("img");
                controllerIndicator.className = "controller-indicator";
                controllerIndicator.src = controllerButtonImages[index] || "";
                controllerIndicator.alt = controllerLabels[index] || "";
                controllerIndicator.title = controllerLabels[index] || "";
                controllerIndicator.style.cssText = `
                    display: ${isMobile ? 'none' : 'inline-block'};
                    margin-right: 8px;
                    width: 32px;
                    height: 32px;
                    vertical-align: middle;
                    object-fit: contain;
                `;
                
                const keyboardIndicator = document.createElement("span");
                keyboardIndicator.className = "keyboard-indicator";
                keyboardIndicator.textContent = (index + 1).toString();
                keyboardIndicator.title = `Press ${index + 1} to select this answer`;
                keyboardIndicator.style.cssText = `
                    display: ${isMobile ? 'none' : 'inline-block'};
                    margin-right: 8px;
                    padding: 4px 8px;
                    background-color: rgba(0, 255, 0, 0.2);
                    border: 2px solid #00ff00;
                    border-radius: 4px;
                    font-size: 16px;
                    font-weight: bold;
                    color: #00ff00;
                    vertical-align: middle;
                    min-width: 24px;
                    text-align: center;
                    font-family: 'ModernDOS', 'Courier New', Courier, monospace;
                `;
                
                choicesdiv.appendChild(choice);
                if (!isMobile) {
                    choicesdiv.appendChild(controllerIndicator);
                    choicesdiv.appendChild(keyboardIndicator);
                }
                choicesdiv.appendChild(choiceLabel);
                opt.appendChild(choicesdiv);
                
                if (!isMobile) {
                    if (gamepadConnected) {
                        controllerIndicator.style.display = "inline-block";
                        keyboardIndicator.style.display = "none";
                    } else {
                        controllerIndicator.style.display = "none";
                        keyboardIndicator.style.display = "inline-block";
                    }
                }
                
                choicesdiv.addEventListener("click", () => {
                    choice.checked = true;
                });
                
                answerOptions.push(choice);
            });
            
            document.querySelector('#btn').style.display = "block";
            
            // Set up 1.5 second timer for all questions
            if (window.answerTimerId) {
                clearInterval(window.answerTimerId);
            }
            const timerDiv = document.querySelector(".timerifinvalid");
            timeToAnswer = 15;
            initialTimeToAnswer = timeToAnswer;
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "#00ff00";
            timerDiv.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
            
            document.querySelector(".correctanswer").innerHTML = "";
            questionStartTime = Date.now();
        }
        
        function loadScore() {
            const totalScore = document.getElementById("score");
            totalScore.innerHTML = `${score}`;
            totalScore.style.fontSize = "xx-large";
            totalScore.style.color = "#00ff00";
            totalScore.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
        }
        
        function stopWatch() {
            const startTime = Date.now();
            const timeDisplay = document.getElementById("timeelapsed");
            timer = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const miliseconds = Math.floor((elapsedTime % 1000) / 10);
                const seconds = Math.floor((elapsedTime / 1000) % 60);
                quizMinutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
                timeDisplay.innerHTML = `${quizMinutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${miliseconds.toString().padStart(2, '0')}`;
                timeDisplay.style.color = "#00ff00";
                timeDisplay.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
            }, 10);
            timeDisplay.style.fontSize = "xx-large";
            timeDisplay.style.textAlign = "center";
        }
        
        function checkAns() {
            if (!allQuestions || allQuestions.length === 0) {
                console.warn("No questions loaded");
                return;
            }
            
            if (currQuestion < 0 || currQuestion >= allQuestions.length) {
                console.warn("Invalid question index");
                return;
            }
            
            const evalDiv = document.querySelector(".evalscreen");
            if (evalDiv && evalDiv.style.display !== "none" && evalDiv.style.display !== "") {
                return;
            }
            
            const selectedAns = document.querySelector('input[name="answer"]:checked');
            if (selectedAns) {
                const answerValue = selectedAns.value;
                const correctAnswer = allQuestions[currQuestion].correct_answer;
                
                function decodeHTMLEntities(text) {
                    if (!text) return "";
                    const txt = document.createElement("textarea");
                    txt.innerHTML = text;
                    return txt.value;
                }
                
                const decodedAnswerValue = decodeHTMLEntities(answerValue);
                const decodedCorrectAnswer = decodeHTMLEntities(correctAnswer);
                
                if (decodedAnswerValue === decodedCorrectAnswer || answerValue === correctAnswer) {
                    score++;
                    loadScore();
                    if (window.answerTimerId) {
                        clearInterval(window.answerTimerId);
                    }
                    showNotification("Correct!", true);
                    nextQuestion();
                } else {
                    showNotification("Wrong! You cannot progress with an incorrect answer.");
                    return;
                }
            } else if (allQuestions.length > 0) {
                showNotification("Please select an answer.");
            }
        }
        
        function nextQuestion() {
            if (currQuestion < allQuestions.length - 1) {
                currQuestion++;
                loadQues();
                document.querySelector(".correctanswer").innerHTML = "";
            } else {
                evalScreen();
            }
        }
        
        function showNotification(message, isSuccess = false) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.classList.remove("hide", "success");
            if (isSuccess) {
                notification.classList.add("success");
            }
            setTimeout(() => {
                notification.classList.add("hide");
            }, 3000);
        }
        
        function evalScreen() {
            // Stop BGM
            stopBGM();
            
            if (timer) {
                clearInterval(timer);
            }
            if (window.answerTimerId) {
                clearInterval(window.answerTimerId);
            }
            
            const evalDiv = document.querySelector(".evalscreen");
            const container = document.querySelector(".container");
            if (container) {
                container.style.display = "none";
            }
            
            const isCompleted = !quizAbandoned && score === allQuestions.length;
            const hasSucceeded = isCompleted;
            
            if (evalDiv) {
                // Position evalscreen on top of everything
                evalDiv.style.position = "fixed";
                evalDiv.style.top = "0";
                evalDiv.style.left = "0";
                evalDiv.style.width = "100%";
                evalDiv.style.height = "100%";
                evalDiv.style.backgroundColor = "#000000";
                evalDiv.style.zIndex = "9999";
                evalDiv.style.display = "flex";
                evalDiv.style.flexDirection = "column";
                evalDiv.style.justifyContent = "center";
                evalDiv.style.alignItems = "center";
                evalDiv.style.color = "#00ff00";
                evalDiv.style.fontFamily = "'ModernDOS', 'Courier New', Courier, monospace";
                
                const resultText = hasSucceeded ? "SUCCESS" : "FAILURE";
                const tootipIfSucceed = hasSucceeded ? "You are nothing short of a spectacle. You are the Absolute Grand Master." : "Game Over.";
                const resultColor = hasSucceeded ? "#00ff00" : "#ff0000";
                
                evalDiv.innerHTML = `
                    <h1 style="color: ${resultColor}; font-family: 'ModernDOS', 'Courier New', Courier, monospace; font-size: 3em; margin-bottom: 30px;">${resultText}</h1>
                    <p style="color: #00ff00; font-family: 'ModernDOS', 'Courier New', Courier, monospace; align-self: center;">${tootipIfSucceed}</p>
                    <button onclick="window.location.href='index.html'" style="background: #000000; color: #00ff00; border: 1px solid #00ff00; padding: 15px 30px; font-family: 'ModernDOS', 'Courier New', Courier, monospace; cursor: pointer; font-size: 1.2em; margin-top: 20px;">Return to Home</button>
                `;
            }
        }
        
    </script>
</body>

</html>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questions</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="status">
        <span class="name hide"></span>
        <a login href="signin.html">Login</a>
        <a signup href="signup.html">Signup</a>
        <a logout class="hide" href="index.html">Log out</a>
        <a giveup href="index.html">Give up</a>
    </div>
    <div class="container">
        <div class="question" id="ques"></div>
        <div class="options" id="opt"></div>
        <button onclick="checkAns()" id="btn">SUBMIT</button>
        <div class="correctanswer"></div>
        <div class="jum" style="display: flex; justify-content: space-between;">
            <div id="score"></div>
            <div id="timeelapsed"></div>
        </div>
        <div class="timerifinvalid"></div>
        <div class="evalscreen" style="display:none"></div>
        <div id="notification" class="notification hide"></div>
    </div>
    <script type="module" src="./IR.js"></script>
    <script type="module" src="./firebase.js"></script>
    <script type="module" src="./hm.js"></script>
</body>
<script type="module">

    import { onAuthStateChanged, getDatabase, getAuth } from "./firebase.js";
    import { ref, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    const auth = getAuth();

    let Questions = [];
    document.querySelector('#btn').addEventListener('click', checkAns);
    const ques = document.getElementById("ques");

    async function fetchQuestions() {
        try {
            const response = await fetch('https://opentdb.com/api.php?amount=20');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            Questions = data.results;
        } catch (error) {
            console.log(error);
            document.querySelector('#btn').innerHTML = "Refresh";
            document.querySelector('#btn').onclick = () => {
                location.reload();
            };
            ques.innerHTML = `<h5 style='color: red'>${error}</h5>`;
        }
    }
    let currQuestion = 0;
    let score = 0;
    let elapsedQuestions = 0;

    ques.innerHTML = `<h5>Please Wait!! Loading Questions...</h5>`;
    document.querySelector('#btn').style.display = "none";
    
    // Handle give up button
    const giveUpBtn = document.querySelector("[giveup]");
    if (giveUpBtn) {
        giveUpBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (confirm("Are you sure you want to give up? Your current progress will be saved.")) {
                // Hide the question when giving up
                const ques = document.getElementById("ques");
                const opt = document.getElementById("opt");
                const btn = document.getElementById("btn");
                if (ques) ques.style.display = "none";
                if (opt) opt.style.display = "none";
                if (btn) btn.style.display = "none";
                evalScreen(true); // Pass true to indicate player gave up
            }
        });
    }

    async function startQuiz() {
        await fetchQuestions();
        if (Questions.length === 0) {
            ques.innerHTML = `<h5 style='color: red'>Unable to fetch data, Please try again!!</h5>`;
            document.querySelector('#btn').style.display = "block";
            document.querySelector('#btn').innerHTML = "Refresh";
            document.querySelector('#btn').onclick = () => {
                location.reload();
            };
        } else {
            loadQues();
            stopWatch();
        }
    }
    startQuiz();

    function loadQues() {
        const opt = document.getElementById("opt");
        let currentQuestion = Questions[currQuestion].question;
        // Decode HTML entities in the question and answers
        function decodeHTMLEntities(text) {
            if (!text) return "";
            const txt = document.createElement('textarea');
            txt.innerHTML = text;
            return txt.value;
        }
        currentQuestion = decodeHTMLEntities(currentQuestion);
        ques.innerHTML = currentQuestion;
        opt.innerHTML = "";
        loadScore();
        const correctAnswer = Questions[currQuestion].correct_answer;
        const incorrectAnswers = Questions[currQuestion].incorrect_answers;
        const options = [correctAnswer, ...incorrectAnswers];
        options.sort(() => Math.random() - 0.5);
        options.forEach((option) => {
            const decodedOption = decodeHTMLEntities(option);
            const choicesdiv = document.createElement("div");
            const choice = document.createElement("input");
            const choiceLabel = document.createElement("label");
            choice.type = "radio";
            choice.name = "answer";
            choice.value = decodedOption;
            choiceLabel.textContent = decodedOption;
            choicesdiv.appendChild(choice);
            choicesdiv.appendChild(choiceLabel);
            opt.appendChild(choicesdiv);
            document.querySelector('#btn').style.display = "block";
            
            // Make the div clickable to select the option
            choicesdiv.addEventListener("click", () => {
                choice.checked = true;
            });
        });
        // Clear any existing question timer
        if (window.questionTimerId) {
            clearInterval(window.questionTimerId);
        }
        
        // Add countdown timer for each question when stopwatch hits 15 minutes
        if (quizMinutes >= 15) {
            let timeToAnswer = 2; // 2 seconds for normal mode
            const timerDiv = document.querySelector(".timerifinvalid");
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "red";
            
            window.questionTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.questionTimerId);
                    nextQuestion();
                }
            }, 10);
        } else {
            const timerDiv = document.querySelector(".timerifinvalid");
            timerDiv.style.display = "none";
        }
        document.querySelector(".correctanswer").innerHTML = "";
    }

    let quizMinutes = 0; // Global variable to track minutes
    let timer; // Global variable to store the timer interval
    function stopWatch() {
        const startTime = Date.now();
        const timeDisplay = document.getElementById("timeelapsed");
        timer = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const miliseconds = Math.floor((elapsedTime % 1000) / 10);
            const seconds = Math.floor((elapsedTime / 1000) % 60);
            quizMinutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
            timeDisplay.innerHTML = `${quizMinutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${miliseconds.toString().padStart(2, '0')}`;
            if (quizMinutes >= 10) {
                timeDisplay.style.color = "yellow";
            }
            if (quizMinutes >= 12) {
                timeDisplay.style.color = "orange";
            }
            if (quizMinutes >= 15) {
                alert("You took too long! This run has been invalidated.");
                timeDisplay.style.color = "red";
            }
        }, 10);
        timeDisplay.style.fontSize = "xx-large";
        timeDisplay.style.textAlign = "center";
    }

    function loadScore() {
        const totalScore = document.getElementById("score");
        totalScore.innerHTML = `${score} / ${currQuestion + 1}`;
        totalScore.style.fontSize = "xx-large";
        totalScore.style.color = "pink";
    }
    function evalScreen(gaveUp = false) {
        const evalDiv = document.querySelector(".evalscreen");
        let grade = "";
        let evalPercent = (score / Questions.length) * 100;
        if (quizMinutes >= 15) {
            grade = "Invalid";
        } else if (evalPercent >= 800 / 9) {
            grade = "AAA";
        } else if (evalPercent >= 700 / 9) {
            grade = "AA";
        } else if (evalPercent >= 600 / 9) {
            grade = "A";
        } else if (evalPercent >= 500 / 9) {
            grade = "B";
        } else if (evalPercent >= 400 / 9) {
            grade = "C";
        } else if (evalPercent >= 300 / 9) {
            grade = "D";
        } else if (evalPercent >= 200 / 9) {
            grade = "E";
        } else {
            grade = "F";
        }
        // Clear all timers
        clearInterval(timer);
        if (window.questionTimerId) {
            clearInterval(window.questionTimerId);
        }
        
        const timeElapsedDiv = document.getElementById("timeelapsed");
        const timerDiv = document.querySelector(".timerifinvalid");
        timerDiv.style.display = "none";

        // Change title based on whether player gave up
        const title = gaveUp ? "Quiz Abandoned" : "Quiz Completed!";

        evalDiv.innerHTML = `<h3>${title}</h3>
                    <p style="font-size:larger">Your score is:</p>
                    <div class="eval" style="display:flex; justify-content:space-between;">
                    <div id="score" >
                    <span class="score" style="font-size:4em">${score}</span> <span style="font-size:xx-large">/ ${Questions.length}</span>
                    </div>
                    <div id=grade>
                    <span class="grade" style="font-size:6em">${grade}</span>
                    </div>
                    </div>
                    <p>Thank you for playing!</p>
                <button onclick="location.reload()">Play Again</button>
                <button class="submitsuffering">Submit your suffe- I mean score</button>
                <button class="home" onclick="location.href='index.html'">Home</button>`;
        evalDiv.style.display = "block";
        evalDiv.style.textAlign = "center";
        // Attach event listener after button is created
        const user = auth.currentUser;
        const submitBtn = document.querySelector(".submitsuffering");
        if (!user) {
            submitBtn.textContent = "Login to submit score";
            submitBtn.onclick = () => {

                location.href = "signin.html";
            };
        }
        if (submitBtn) {
            let isSubmitting = false;
            submitBtn.addEventListener("click", async () => {
                if (isSubmitting || submitBtn.disabled) return;
                
                if (!user) return;
                
                // Prevent invalid scores from being submitted
                if (quizMinutes >= 15) {
                    alert("Invalid run! Scores cannot be submitted for runs that took 15 minutes or longer.");
                    return;
                }
                
                isSubmitting = true;
                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting...";
                
                try {
                    // Use Firebase v9+ modular SDK
                    const db = getDatabase();

                    await push(ref(db, 'scores'), {
                        name: user.displayName || user.email,
                        score: score,
                        grade: grade,
                        time: document.getElementById("timeelapsed").textContent,
                        date: new Date().toLocaleString()
                    });
                    alert("Score submitted successfully!");
                    submitBtn.textContent = "Score submitted!";
                    submitBtn.style.backgroundColor = "cyan";
                    submitBtn.style.color = "white";
                    submitBtn.style.cursor = "not-allowed";
                } catch (error) {
                    console.error("Error submitting score:", error);
                    alert("Failed to submit score. Please try again.");
                    submitBtn.disabled = false;
                    isSubmitting = false;
                    submitBtn.textContent = "Submit your suffe- I mean score";
                }
            });
        }

    }
    function nextQuestion() {
        if (currQuestion < Questions.length - 1) {
            currQuestion++;
            loadQues();
            document.querySelector(".correctanswer").innerHTML = "";
        } else {
            document.getElementById("opt").remove();
            document.getElementById("ques").remove();
            document.getElementById("btn").remove();
            document.getElementById("score").remove();
            evalScreen();
        }
    }

    function showNotification(message, isSuccess = false) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.classList.remove("hide", "success");
        if (isSuccess) {
            notification.classList.add("success");
        }
        setTimeout(() => {
            notification.classList.add("hide");
        }, 3000);
    }

    function checkAns() {
        const selectedAns = document.querySelector('input[name="answer"]:checked');
        if (!selectedAns && quizMinutes >= 15) {
            // If time is invalid and no answer is selected, skip to next question without alert
            nextQuestion();
            return;
        }
        if (selectedAns) {
            const answerValue = selectedAns.value;
            if (answerValue === Questions[currQuestion].correct_answer) {
                score++;
                showNotification("Correct!", true);
            }
            else {
                // Don't expose the correct answer to prevent cheating
                showNotification("Wrong! Try again next time.");
            }
            nextQuestion();
        } else if (!selectedAns && Questions.length > 0) {
            showNotification("Please select an answer.");
        }
    }


</script>

</html>
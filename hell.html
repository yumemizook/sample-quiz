<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUFFERING IS ETERNAL</title>
    <link rel="stylesheet" href="index.css">
    <style>
        body {
            background: url("hell1.jpg") no-repeat center center fixed;
            background-size: cover;
        }

        .container button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #ffb9b9;
            color: rgb(104, 104, 104);
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            z-index: -1;
        }
        a {
            text-decoration: none;
            color: #ffbaba;
            font-size: x-large;
        }
    </style>
</head>

<body>
    <div class="status">
        <span class="name hide"></span>
        <a login href="signin.html">Login</a>
        <a signup href="signup.html">Signup</a>
        <a logout class="hide" href="index.html">Log out</a>
        <a giveup href="index.html">Give up</a>
    </div>
    <div class="container">
        <div class="question" id="ques"></div>
        <div class="options" id="opt"></div>
        <button onclick="checkAns()" id="btn">SUBMIT</button>
        <div class="correctanswer"></div>
        <div class="jum" style="display: flex; justify-content: space-between;">
            <div id="score"></div>
            <div id="timeelapsed"></div>
        </div>
        <div class="timerifinvalid"></div>
        <div class="evalscreen" style="display:none"></div>
    </div>
    <script type="module" src="./IR.js"></script>
    <script type="module" src="./firebase.js"></script>
    <script type="module" src="./hm.js"></script>
</body>
<script type="module">

    import { onAuthStateChanged, getDatabase, getAuth } from "./firebase.js";
    import { ref, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    const auth = getAuth();

    let Questions = [];
    document.querySelector('#btn').addEventListener('click', checkAns);
    const ques = document.getElementById("ques");

    async function fetchQuestions() {
        try {
            const response = await fetch('https://opentdb.com/api.php?amount=50&difficulty=hard&type=multiple');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            Questions = data.results;
        } catch (error) {
            console.log(error);
            document.querySelector('#btn').innerHTML = "Refresh";
            document.querySelector('#btn').onclick = () => {
                location.reload();
            };
            ques.innerHTML = `<h5 style='color: red'>${error}</h5>`;
        }
    }
    let currQuestion = 0;
    let score = 0;
    let elapsedQuestions = 0;

    ques.innerHTML = `<h5>Please Wait!! Loading Questions...</h5>`;
    document.querySelector('#btn').style.display = "none";

    async function startQuiz() {
        await fetchQuestions();
        if (Questions.length === 0) {
            ques.innerHTML = `<h5 style='color: red'>Unable to fetch data, Please try again!!</h5>`;
            document.querySelector('#btn').style.display = "block";
            document.querySelector('#btn').innerHTML = "Refresh";
            document.querySelector('#btn').onclick = () => {
                location.reload();
            };
        } else {
            loadQues();
            stopWatch();
        }
    }
    startQuiz();

    let timeToAnswer;
    function loadQues() {
        const opt = document.getElementById("opt");
        let currentQuestion = Questions[currQuestion].question;
        // Decode HTML entities in the question string
        function decodeHTMLEntities(text) {
            const txt = document.createElement('textarea');
            txt.innerHTML = text;
            return txt.value;
        }
        currentQuestion = decodeHTMLEntities(currentQuestion);
        ques.innerHTML = currentQuestion;
        opt.innerHTML = "";
        loadScore();
        const correctAnswer = Questions[currQuestion].correct_answer;
        const incorrectAnswers = Questions[currQuestion].incorrect_answers;
        const options = [correctAnswer, ...incorrectAnswers];
        options.sort(() => Math.random() - 0.5);
        options.forEach((option) => {
            const choicesdiv = document.createElement("div");
            const choice = document.createElement("input");
            const choiceLabel = document.createElement("label");
            choice.type = "radio";
            choice.name = "answer";
            choice.value = option;
            choiceLabel.textContent = option;
            choicesdiv.appendChild(choice);
            choicesdiv.appendChild(choiceLabel);
            opt.appendChild(choicesdiv);
            document.querySelector('#btn').style.display = "block";
        });

        let answerTimerId; // Store interval ID for answer timer
        // Clear any previous interval to prevent multiple timers
        if (window.answerTimerId) {
            clearInterval(window.answerTimerId);
        }
        const timerDiv = document.querySelector(".timerifinvalid");
        if (quizMinutes >= 15) {
            timeToAnswer = 1; // Set a short time for invalidated runs
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "red";
        } else if (currQuestion < 5) { // This will converge to a very strict time curve over the span of the quiz, trust me
            timeToAnswer = 12; // Lower time than Master's lowest time
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
        } else if (currQuestion <= 10) {
            timeToAnswer = 12; // Let the player have false hope
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell2.jpg')";
        } else if (currQuestion <= 15) {
            timeToAnswer = 10; // The decsent begins here
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell3.jpg')";
        } else if (currQuestion <= 20) {
            timeToAnswer = 9
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell4.jpg')";
        } else if (currQuestion <= 20) {
            timeToAnswer = 8
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell5.jpg')";
        } else if (currQuestion <= 25) {
            timeToAnswer = 6
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell6.jpg')";
        } else if (currQuestion <= 30) {
            timeToAnswer = 4
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell7.jpg')";
        } else if (currQuestion <= 35) {
            timeToAnswer = 3
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell8.jpg')";
        } else if (currQuestion <= 40) {
            timeToAnswer = 2.5
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell9.jpg')";
        } else if (currQuestion <= 45) {
            timeToAnswer = 2 // The almost final stretch (can people even finish this?)
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell10.jpg')";
        } else if (currQuestion <= Questions.length) {
            timeToAnswer = 1.5 // Probably TAS territory
            window.answerTimerId = setInterval(() => {
                if (timeToAnswer > 0) {
                    timeToAnswer -= 0.01;
                    timerDiv.innerHTML = `${timeToAnswer.toFixed(2)}`;
                } else {
                    clearInterval(window.answerTimerId);
                    evalScreen();
                }
            }, 10);
            timerDiv.style.display = "block";
            timerDiv.style.textAlign = "center";
            timerDiv.style.fontSize = "xx-large";
            timerDiv.style.color = "white";
            document.body.style.backgroundImage = "url('hell10.jpg')";
        }
        document.querySelector(".correctanswer").innerHTML = "";
    }

    let quizMinutes = 0; // Global variable to track minutes
    let timer; // Global variable to store the timer interval
    function stopWatch() {
        const startTime = Date.now();
        const timeDisplay = document.getElementById("timeelapsed");
        timer = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const miliseconds = Math.floor((elapsedTime % 1000) / 10);
            const seconds = Math.floor((elapsedTime / 1000) % 60);
            quizMinutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
            timeDisplay.innerHTML = `${quizMinutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${miliseconds.toString().padStart(2, '0')}`;
            if (quizMinutes >= 10) {
                timeDisplay.style.color = "yellow";
            }
            if (quizMinutes >= 12) {
                timeDisplay.style.color = "orange";
            }
            if (quizMinutes >= 15) {
                alert("You took too long! This run has been invalidated.");
                timeDisplay.style.color = "red";
            }
        }, 10);
        timeDisplay.style.fontSize = "xx-large";
        timeDisplay.style.textAlign = "center";
    }

    function loadScore() {
        const totalScore = document.getElementById("score");
        totalScore.innerHTML = `${score}`;
        totalScore.style.fontSize = "xx-large";
        totalScore.style.color = "pink";
    }
    function evalScreen() {
        document.getElementById("opt").remove();
        document.getElementById("ques").remove();
        document.getElementById("btn").remove();
        document.getElementById("score").remove();
        const evalDiv = document.querySelector(".evalscreen");
        let grade = "";
        let evalPercent = (score / Questions.length) * 100;
        if (quizMinutes >= 15) {
            grade = "Invalid";
        } else if (evalPercent == 100) {
            grade = "∞";
        } else if (evalPercent >= 90) {
            grade = "EX";
        } else if (evalPercent >= 75) {
            grade = "GM";
        } else if (evalPercent >= 50) {
            grade = "MM";
        } else if (evalPercent >= 40) {
            grade = "M";
        } else if (evalPercent >= 20) {
            grade = "S";
        } else {
            grade = "";
        }
        const timeElapsedDiv = document.getElementById("timeelapsed");
        clearInterval(timer); // Clear the timer interval
        const timerDiv = document.querySelector(".timerifinvalid");
        timerDiv.style.display = "none";


        evalDiv.innerHTML = `<h3>Game Over.</h3>
                    <p style="font-size:larger">Your score is:</p>
                    <div class="eval" style="display:flex; justify-content:space-between;">
                    <div id="score" >
                    <span class="score" style="font-size:4em">${score}</span> <span style="font-size:xx-large">/ ${Questions.length}</span>
                    </div>
                    <div id=grade>
                    <span class="grade" style="font-size:6em">${grade}</span>
                    </div>
                    </div>
                    <p>Thank you for playing!</p>
                <button onclick="location.reload()">Play Again</button>
                <button class="submitsuffering">Submit your suffe- I mean score</button>
                <button class="home" onclick="location.href='index.html'">Home</button>`;
        evalDiv.style.display = "block";
        evalDiv.style.textAlign = "center";
        // Attach event listener after button is created
        const user = auth.currentUser;
        const submitBtn = document.querySelector(".submitsuffering");
        if (!user) {
            submitBtn.textContent = "Login to submit score";
            submitBtn.onclick = () => {

                location.href = "signin.html";
            };
        }
        if (submitBtn) {
            submitBtn.addEventListener("click", async () => {

                if (user) {
                    try {
                        // Use Firebase v9+ modular SDK
                        const db = getDatabase();

                        await push(ref(db, 'scoresfinal'), {
                            name: user.displayName || user.email,
                            score: score,
                            grade: grade,
                            time: document.getElementById("timeelapsed").textContent,
                            date: new Date().toLocaleString()
                        });
                        alert("Score submitted successfully!");
                        submitBtn.textContent = "Score submitted!";
                        submitBtn.disabled = true; // Disable the button after submission
                        submitBtn.style.backgroundColor = "cyan";
                        submitBtn.style.color = "white";
                        submitBtn.style.cursor = "not-allowed";
                    } catch (error) {
                        console.error("Error submitting score:", error);
                        alert("Failed to submit score. Please try again.");
                    }
                }
            });
        }

    }
    function nextQuestion() {
        if (currQuestion < Questions.length - 1) {
            currQuestion++;
            loadQues();
            document.querySelector(".correctanswer").innerHTML = "";
        } else {
            evalScreen();
        }
    }

    function checkAns() {
        const selectedAns = document.querySelector('input[name="answer"]:checked');
        if (selectedAns) {
            const answerValue = selectedAns.value;
            if (answerValue === Questions[currQuestion].correct_answer) {
                score++;
                nextQuestion();
            } else {
                alert(`Wrong!`);
                return;
            }
        } else if (Questions.length > 0) {
            alert("Please select an answer.");
        }
    }


</script>

</html>
